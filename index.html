<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mist√©rios das Sombras em Beckland</title>
   <!-- Importa√ß√£o de Fontes G√≥ticas e Cl√°ssicas -->
    <!-- Importa√ß√£o de Fontes G√≥ticas e Cl√°ssicas -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&family=Almendra+Display&family=Cardo:ital,wght@0,400;0,700;1,400&family=EB+Garamond&display=swap" rel="stylesheet">

    <!-- Bibliotecas de Anima√ß√£o -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>

    <style>
        :root {
            --bg-deep: #0b0510; /* Roxo quase preto */
            --text-main: #dcd0c0; /* Papel envelhecido claro */
            --text-dim: #8a8a8a;
            --accent-red: #5e0000; /* Sangue seco */
            --accent-gold: #c5a059; /* Ouro envelhecido */
            --panel-bg: rgba(15, 10, 20, 0.95); /* Veludo escuro */
            --sanity-smoke: #6a4c93;
            --font-title: 'UnifrakturMaguntia', cursive;
            --font-header: 'Almendra Display', serif;
            --font-body: 'Cardo', serif;
        }

        body {
            margin: 0;
            padding: 0;
            background: #000 radial-gradient(circle at 50% 40%, #1a0b2e 0%, #050208 60%, #000000 100%);
            color: var(--text-main);
            font-family: var(--font-body);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Container 3D (Fundo Din√¢mico) */
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Fica atr√°s da UI */
        }

        /* Utilit√°rios de Tela */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        /* Centralizador para telas de menu (Login/Lobby) */
        .screen-centered {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .screen-centered.active {
            display: flex;
        }

        .active {
            display: block;
        }

        /* Estiliza√ß√£o dos Componentes */
        h1, h2 {
            font-family: var(--font-title);
            color: var(--accent-gold);
            font-weight: normal;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            margin-top: 0;
        }

        .panel {
            background: var(--panel-bg);
            /* Borda dupla estilo vitoriano */
            border: 1px solid var(--accent-gold);
            outline: 4px double var(--accent-gold);
            outline-offset: -10px;
            padding: 40px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.95);
            max-width: 600px;
            width: 90%;
            text-align: center;
            position: relative;
        }
        
        /* Efeito de pulsa√ß√£o na luz (borda) */
        .panel-pulse {
            animation: pulse-light 3s infinite;
        }
        
        @keyframes pulse-light {
            0% { box-shadow: 0 0 20px rgba(197, 160, 89, 0.2); }
            50% { box-shadow: 0 0 40px rgba(197, 160, 89, 0.6); }
            100% { box-shadow: 0 0 20px rgba(197, 160, 89, 0.2); }
        }

        input {
            width: 80%;
            padding: 10px;
            margin: 10px 0;
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--accent-gold);
            color: var(--text-main);
            font-family: var(--font-header);
            font-size: 1.2rem;
            text-align: center;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-bottom-color: #fff;
        }
        
        /* Sele√ß√£o de Afinidade (√çcones) */
        .affinity-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .affinity-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 1px solid var(--accent-gold);
            background: rgba(0,0,0,0.5);
            color: var(--accent-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            font-size: 24px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }
        
        .affinity-icon:hover, .affinity-icon.selected {
            background: radial-gradient(circle, var(--accent-gold) 0%, #000 120%);
            color: #fff;
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--accent-gold);
            border-color: #fff;
        }
        
        .tooltip {
            display: none;
            position: absolute;
            bottom: -30px;
            background: #000;
            color: #fff;
            font-size: 12px;
            padding: 2px 5px;
            white-space: nowrap;
            border: 1px solid var(--accent-gold);
        }
        
        .affinity-icon:hover .tooltip {
            display: block;
        }

        button {
            background: linear-gradient(to bottom, #2a0e0e, #1a0505);
            color: var(--accent-gold);
            border: 1px solid var(--accent-gold);
            padding: 12px 30px;
            font-size: 1.2rem;
            cursor: pointer;
            font-family: var(--font-header);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
            margin: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.8);
            position: relative;
            overflow: hidden;
        }

        button:hover {
            background: var(--accent-red);
            color: #fff;
            box-shadow: 0 0 20px var(--accent-red);
            border-color: #ff4444;
        }

        .narrative-text {
            font-family: var(--font-body);
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: justify;
            color: #ccc;
        }

        /* Configura√ß√µes (Engrenagem) */
        #settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            font-size: 24px;
            z-index: 1001;
            cursor: pointer;
            filter: drop-shadow(0 0 5px #000);
        }
        
        /* Modal de Configura√ß√µes */
        #settings-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        /* --- LAYOUT DO JOGO (Mundo de Mist√©rio) --- */
        #screen-game {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* Topo: Lua */
        .hud-top {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }
        .moon-icon {
            font-size: 40px;
            text-shadow: 0 0 20px #fff;
        }

        /* Lateral Esquerda: Status */
        .hud-left {
            position: absolute;
            top: 100px;
            left: 20px;
            width: 220px;
        }
        .status-label { font-family: var(--font-header); font-size: 1rem; color: var(--accent-gold); margin-bottom: 5px; display: block; }
        
        .sanity-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.5);
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
            position: relative;
        }
        .sanity-bar-fill {
            width: 100%;
            height: 100%;
            /* Efeito de fuma√ßa roxa */
            background: linear-gradient(90deg, transparent, var(--sanity-smoke), transparent);
            filter: blur(2px);
            transition: width 0.5s;
        }
        /* Efeito de rachadura (simulado com gradiente) */
        .sanity-cracked {
            background: linear-gradient(90deg, #5e0000, #8a0000); /* Cor de ferrugem/sangue */
            filter: blur(1px);
        }

        .sequence-display {
            font-family: var(--font-title);
            font-size: 4rem;
            color: var(--accent-gold);
            text-shadow: 0 0 20px rgba(197, 160, 89, 0.4);
            font-weight: bold;
            text-align: center;
            border: none;
            width: 100px;
            height: 100px;
            line-height: 100px;
            margin: 0 auto;
            background: radial-gradient(circle, rgba(197, 160, 89, 0.1) 0%, transparent 70%);
        }

        /* Lateral Direita: Pap√©is */
        .hud-right {
            position: absolute;
            top: 100px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: flex-end;
        }
        .role-btn {
            background: transparent;
            border: 1px solid rgba(197, 160, 89, 0.3);
            border-left: 4px solid var(--accent-gold);
            color: var(--text-main);
            padding: 10px 15px;
            cursor: pointer;
            text-align: right;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: var(--font-header);
        }
        .role-btn:hover {
            background: linear-gradient(to left, rgba(197, 160, 89, 0.2), transparent);
            border-color: var(--accent-gold);
            text-shadow: 0 0 5px var(--accent-gold);
        }

        /* Inferior: Chat e Skills */
        .hud-bottom-left {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 350px;
            max-width: 40%;
        }
        .chat-box {
            background: rgba(0,0,0,0.6);
            border: 1px solid #333;
            height: 200px;
            display: flex;
            flex-direction: column;
            border-radius: 2px;
            padding: 10px;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            font-family: var(--font-body);
            font-size: 1rem;
            margin-bottom: 10px;
            text-align: left;
            color: #bbb;
        }
        .chat-input {
            width: 100%;
            box-sizing: border-box;
            background: rgba(255,255,255,0.05);
            border: none;
            border-bottom: 1px solid #555;
            padding: 5px;
            color: var(--text-main);
            font-family: var(--font-body);
        }

        .hud-bottom-right {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
        }
        .skill-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            /* Estilo esbo√ßo/frasco */
            border: 2px dashed rgba(197, 160, 89, 0.5);
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .skill-circle:hover {
            transform: scale(1.1);
            border-style: solid;
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px var(--accent-gold);
        }

        /* Efeito Lua Vermelha */
        .red-moon-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            /* Tom de vinho/queimado */
            background: rgba(60, 10, 10, 0.3);
            box-shadow: inset 0 0 200px #2a0000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 2s;
            z-index: 999;
            mix-blend-mode: soft-light;
            filter: sepia(0.8) hue-rotate(-50deg) contrast(1.2);
        }
        .red-moon-active {
            opacity: 1;
        }

        /* Lottie Overlay (Camada M√≠stica) */
        .lottie-mystic {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            pointer-events: none;
            z-index: 2000;
            mix-blend-mode: screen; /* Funde a luz da anima√ß√£o com o fundo escuro */
            display: none;
        }
    </style>
</head>
<body>

    <!-- Efeito Visual Global -->
    <div id="red-moon-fx" class="red-moon-overlay"></div>

    <!-- Canvas 3D Three.js -->
    <div id="canvas-container"></div>

    <!-- Container Lottie para Rituais (Overlay) -->
    <div id="lottie-ritual" class="lottie-mystic"></div>

    <!-- Bot√£o de Configura√ß√µes Global -->
    <button id="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>

    <!-- Modal de Configura√ß√µes -->
    <div id="settings-modal">
        <div class="panel">
            <h2>Configura√ß√µes</h2>
            <button onclick="alert('Volume ajustado')">üîä Volume</button>
            <button onclick="alert('Hist√≥rico de Pistas')">üìú Hist√≥rico (Espectador)</button>
            <button onclick="location.reload()">üö™ Sair da Mans√£o</button>
            <br><br>
            <button onclick="toggleSettings()" style="background: #333;">Fechar</button>
        </div>
    </div>

    <!-- TELA 1: LOGIN -->
    <div id="screen-login" class="screen screen-centered active">
        <div class="panel panel-pulse">
            <!-- Container Lottie -->
            <div id="lottie-login" style="width: 100px; height: 100px; margin: 0 auto;"></div>
            <h1>Mist√©rios das Sombras</h1>
            <h2>Beckland</h2>
            <p>Insira seus dados para adentrar a n√©voa.</p>
            
            <input type="text" id="player-name" placeholder="Digite seu nome de Beyonder">
            
            <p style="color: var(--accent-gold); margin-top: 20px;">Escolha sua Afinidade</p>
            <div class="affinity-selector" id="affinity-container">
                <!-- Gerado via JS ou est√°tico -->
                <div class="affinity-icon" onclick="selectAffinity('louco', this)">ü§°<span class="tooltip">Louco</span></div>
                <div class="affinity-icon" onclick="selectAffinity('espectador', this)">üëÅÔ∏è<span class="tooltip">Espectador</span></div>
                <div class="affinity-icon" onclick="selectAffinity('aprendiz', this)">üö™<span class="tooltip">Aprendiz</span></div>
                <div class="affinity-icon" onclick="selectAffinity('marinheiro', this)">‚öì<span class="tooltip">Marinheiro</span></div>
                <div class="affinity-icon" onclick="selectAffinity('bruxa', this)">üîÆ<span class="tooltip">Bruxa</span></div>
            </div>

            <br>
            <button onclick="handleLogin()">Iniciar Sess√£o</button>
        </div>
    </div>

    <!-- TELA 2: NARRATIVA -->
    <div id="screen-narrative" class="screen screen-centered">
        <div class="panel">
            <h2>A Chegada</h2>
            <div class="narrative-text">
                <p>A n√©voa de Beckland √© densa e carrega o cheiro de carv√£o e mist√©rio. Voc√™ desperta em um mundo paralelo, onde a lua √†s vezes sangra no c√©u.</p>
                <p>Voc√™ foi convidado para um bazar beneficente em uma mans√£o luxuosa. Mas os sussurros dizem que algo profano caminha entre os convidados.</p>
                <p>Prepare sua po√ß√£o. Controle sua sanidade. Sobreviva.</p>
            </div>
            <button onclick="goToLobby()">Entrar na Mans√£o</button>
        </div>
    </div>

    <!-- TELA 3: LOBBY (DOM√çNIO) -->
    <div id="screen-lobby" class="screen screen-centered">
        <div class="panel">
            <h2>Gest√£o de Dom√≠nio</h2>
            <p>Bem-vindo, <span id="display-name" style="color: var(--accent-gold);"></span>.</p>
            <p>Caminho: <span id="display-affinity"></span></p>
            
            <hr style="border-color: var(--accent-gold); opacity: 0.3;">

            <div id="lobby-controls">
                <h3>Criar Dom√≠nio</h3>
                <label>Justiceiros: <input type="number" id="num-justiceiros" value="1" min="1" style="width: 50px;"></label>
                <label>Monstros: <input type="number" id="num-monstros" value="1" min="1" style="width: 50px;"></label>
                <br>
                <button onclick="createRoom()">Gerar C√≥digo da Sala</button>
            </div>

            <div id="join-controls">
                <h3>Entrar no Dom√≠nio</h3>
                <input type="text" id="room-code-input" placeholder="C√≥digo da Sala">
                <br>
                <button onclick="joinRoom()">Entrar</button>
            </div>

            <div id="room-status" style="display:none; margin-top: 20px;">
                <p>Sala: <strong id="current-room-code" style="font-family: var(--font-title); font-size: 1.5rem;">---</strong></p>
                <p>Aguardando jogadores...</p>
                <div id="lobby-player-list" style="margin-bottom: 10px; color: #aaa; font-size: 0.9rem;"></div>
                <div id="lobby-chat-box" style="height: 100px; background: rgba(0,0,0,0.5); border: 1px solid #333; overflow-y: scroll; text-align: left; padding: 5px; font-family: var(--font-body);">
                    <em style="color: gray;">Chat Global do Lobby conectado...</em>
                </div>
                <br>
                <button onclick="startGame()">Entrar no Mundo de Mist√©rio</button>
            </div>
        </div>
    </div>

    <!-- TELA 4: JOGO (MUNDO DE MIST√âRIO) -->
    <div id="screen-game" class="screen">
        
        <!-- Topo -->
        <div class="hud-top">
            <div class="moon-icon" id="moon-phase">üåë</div>
            <small style="color: #aaa;">Fase da Lua</small>
        </div>

        <!-- Esquerda -->
        <div class="hud-left">
            <span class="status-label">Sanidade</span>
            <div class="sanity-bar-container">
                <div class="sanity-bar-fill" style="width: 100%;"></div>
            </div>
            
            <span class="status-label" style="text-align: center;">Sequ√™ncia</span>
            <div class="sequence-display">IX</div>
        </div>

        <!-- Direita -->
        <div class="hud-right">
            <div class="role-btn">üî™ Instinto Assassino</div>
            <div class="role-btn">‚öñÔ∏è Decretar Pris√£o</div>
            <div class="role-btn">üëÅÔ∏è Observar</div>
        </div>

        <!-- Inferior -->
        <div class="hud-bottom-left">
            <div class="chat-box">
                <div class="chat-messages" id="game-chat-messages">
                    <div style="color: var(--accent-gold);">Sistema: Bem-vindo √† Mans√£o.</div>
                </div>
                <input type="text" class="chat-input" id="game-chat-input" placeholder="Sussurrar..." onkeypress="handleChatInput(event)">
            </div>
        </div>

        <div class="hud-bottom-right">
            <div class="skill-circle" onclick="triggerEvolutionSequence()">‚öóÔ∏è</div>
            <div class="skill-circle">üîÆ</div>
        </div>

        
    </div>
<script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
}
</script>

<script type="module">
    // Importa√ß√µes do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, push, onValue, onDisconnect, remove, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
    // Importa√ß√µes do Three.js usando o Import Map
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // --- CONFIGURA√á√ÉO FIREBASE ---
    // Mesmo usando s√≥ o databaseURL, o Firebase espera o objeto completo ou vazio para as outras chaves
    const firebaseConfig = {
        apiKey: "AIza...", // Opcional para RTDB, mas recomendado incluir se tiver
        databaseURL: "https://mystery02-864a8-default-rtdb.firebaseio.com/",
        projectId: "mystery02-864a8",
        appId: "1:..." 
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- VARI√ÅVEIS GLOBAIS 3D ---
    let scene, camera, renderer, modelGroup, redMoonMaterial;
    let raycaster = new THREE.Raycaster();
    let mouse = new THREE.Vector2();
    const objectsToAnimate = {};
        // Estado do Jogo
        window.gameState = {
            name: '',
            affinity: '',
            roomCode: null,
            playerId: 'player_' + Math.random().toString(36).substr(2, 9)
        };

        // Inicializa√ß√£o do Lottie
        document.addEventListener("DOMContentLoaded", () => {
            // 1. UI Est√°tica (Olho M√≠stico - Login)
            window.lottieLogin = lottie.loadAnimation({
                container: document.getElementById('lottie-login'),
                renderer: 'svg',
                loop: true,
                autoplay: false, // Controle manual via GSAP
                // URL de exemplo de um olho m√≠stico (substitua por seu JSON local se preferir)
                path: 'https://lottie.host/4b826603-3436-4402-9231-40330098521d/0X4X4X4X4X.json' 
            });

            // 2. Efeito de Ritual (Fuma√ßa/Magia)
            window.lottieRitual = lottie.loadAnimation({
                container: document.getElementById('lottie-ritual'),
                renderer: 'svg',
                loop: false,
                autoplay: false,
                // Reutilizando URL para exemplo (Ideal: usar um JSON de fuma√ßa/runas)
                path: 'https://lottie.host/4b826603-3436-4402-9231-40330098521d/0X4X4X4X4X.json' 
            });

            // Inicializar o mundo 3D
            init3D();
        });

        // Navega√ß√£o entre telas
        window.showScreen = function(screenId) {
            const currentScreen = document.querySelector('.screen.active');
            const nextScreen = document.getElementById(screenId);

            // Performance: Pausar Lottie se sair do Login
            if (currentScreen && currentScreen.id === 'screen-login' && window.lottieLogin) {
                window.lottieLogin.pause();
            }

            if (currentScreen && currentScreen !== nextScreen) {
                // Anima√ß√£o de Sa√≠da (GSAP)
                gsap.to(currentScreen, {
                    duration: 0.5,
                    opacity: 0,
                    y: -20,
                    ease: "power2.in",
                    onComplete: () => {
                        currentScreen.classList.remove('active');
                        // Reseta propriedades para a pr√≥xima vez
                        gsap.set(currentScreen, { clearProps: "all" });
                        activateNextScreen(nextScreen);
                    }
                });
            } else {
                activateNextScreen(nextScreen);
            }
        }

        function activateNextScreen(screen) {
            screen.classList.add('active');
            
            // Tocar Lottie se entrar no Login
            if (screen.id === 'screen-login' && window.lottieLogin) {
                window.lottieLogin.play();
            }

            // Anima√ß√£o de Entrada (GSAP)
            gsap.fromTo(screen, 
                { opacity: 0, y: 20 }, 
                { duration: 0.8, opacity: 1, y: 0, ease: "power2.out" }
            );

            // Anima√ß√µes Espec√≠ficas por Cena
            if (screen.id === 'screen-narrative') {
                // Efeito "Typewriter" ou apari√ß√£o sequencial no texto
                gsap.from(".narrative-text p", {
                    duration: 1,
                    opacity: 0,
                    y: 10,
                    stagger: 0.8, // Tempo entre cada par√°grafo
                    delay: 0.3,
                    ease: "power2.out"
                });
            }
        }

        // Sele√ß√£o de Afinidade
        window.selectAffinity = function(value, element) {
            gameState.affinity = value;
            // Remove classe selected de todos
            document.querySelectorAll('.affinity-icon').forEach(el => el.classList.remove('selected'));
            // Adiciona ao clicado
            element.classList.add('selected');
        }

        // L√≥gica de Login
        window.handleLogin = function() {
            const nameInput = document.getElementById('player-name').value;
            // affinity j√° est√° no gameState via selectAffinity

            if (!nameInput || !gameState.affinity) {
                alert("Por favor, preencha seu nome e escolha um caminho.");
                return;
            }

            gameState.name = nameInput;

            // Persist√™ncia simples (Session Storage)
            sessionStorage.setItem('beyonderName', nameInput);

            showScreen('screen-narrative');
        }

        window.goToLobby = function() {
            document.getElementById('display-name').innerText = gameState.name;
            document.getElementById('display-affinity').innerText = gameState.affinity.toUpperCase();
            showScreen('screen-lobby');
        }

        // Simula√ß√£o de Cria√ß√£o de Sala
        window.createRoom = function() {
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            gameState.roomCode = code;
            
            // Estrutura Inicial da Sala no Firebase
            const roomRef = ref(db, 'dominios/' + code);
            set(roomRef, {
                status: "lobby",
                lua_vermelha: false,
                configuracoes: { qtd_monstros: 1, qtd_justiceiros: 1 }
            });

            joinRoomLogic(code);
        }

        window.joinRoom = function() {
            const code = document.getElementById('room-code-input').value.toUpperCase();
            if(!code) return alert("Insira um c√≥digo.");
            gameState.roomCode = code;
            joinRoomLogic(code);
        }

        function joinRoomLogic(code) {
            // Adicionar Jogador
            const playerRef = ref(db, 'dominios/' + code + '/jogadores/' + gameState.playerId);
            set(playerRef, {
                nome: gameState.name,
                affinity: gameState.affinity,
                papel: "Desconhecido", // Ser√° definido depois
                sequencia: 9,
                sanidade: 100
            });

            // Remover ao desconectar (evita salas fantasmas)
            onDisconnect(playerRef).remove();

            // Atualizar UI
            document.getElementById('lobby-controls').style.display = 'none';
            document.getElementById('join-controls').style.display = 'none';
            document.getElementById('room-status').style.display = 'block';
            document.getElementById('current-room-code').innerText = code;

            setupRoomListeners(code);
        }

        function setupRoomListeners(code) {
            // Ouvir Jogadores
            onValue(ref(db, 'dominios/' + code + '/jogadores'), (snapshot) => {
                const players = snapshot.val() || {};
                const listDiv = document.getElementById('lobby-player-list');
                listDiv.innerHTML = "Jogadores: " + Object.values(players).map(p => p.nome).join(', ');
            });

            // Ouvir Status da Sala
            onValue(ref(db, 'dominios/' + code + '/status'), (snapshot) => {
                if (snapshot.val() === 'em_jogo') {
                    showScreen('screen-game');
                }
            });

            // Ouvir Lua Vermelha
            onValue(ref(db, 'dominios/' + code + '/lua_vermelha'), (snapshot) => {
                if (snapshot.val() === true) {
                    triggerRedMoonEffect();
                }
            });

            // Ouvir Chat
            onValue(ref(db, 'dominios/' + code + '/chat'), (snapshot) => {
                const messages = snapshot.val() || {};
                const chatDiv = document.getElementById('game-chat-messages');
                const lobbyChatDiv = document.getElementById('lobby-chat-box');
                
                let html = '';
                Object.values(messages).forEach(msg => {
                    html += `<div><strong style="color: var(--accent-gold);">${msg.usuario}:</strong> ${msg.texto}</div>`;
                });
                
                chatDiv.innerHTML = html;
                lobbyChatDiv.innerHTML = html;
                chatDiv.scrollTop = chatDiv.scrollHeight;
            });
        }

        window.startGame = function() {
            update(ref(db, 'dominios/' + gameState.roomCode), {
                status: "em_jogo"
            });
        }

        window.handleChatInput = function(e) {
            if (e.key === 'Enter') {
                const input = document.getElementById('game-chat-input');
                const text = input.value;
                if (text.trim() === '') return;

                push(ref(db, 'dominios/' + gameState.roomCode + '/chat'), {
                    usuario: gameState.name,
                    texto: text,
                    timestamp: Date.now()
                });
                input.value = '';
            }
        }

        function triggerRedMoonEffect() {
            const overlay = document.getElementById('red-moon-fx');
            const moonIcon = document.getElementById('moon-phase');
            
            // Sequ√™ncia de Anima√ß√£o Dram√°tica (GSAP)
            const tl = gsap.timeline();

            // 1. Tremor na Tela (Press√°gio)
            tl.to("body", { 
                x: -4, 
                duration: 0.05, 
                repeat: 10, 
                yoyo: true, 
                ease: "rough" 
            })
            // 2. Lua Colapsa (Some)
            .to(moonIcon, { 
                duration: 0.4, 
                scale: 0, 
                opacity: 0, 
                ease: "back.in(1.7)" 
            })
            // 3. Explos√£o da Lua de Sangue
            .call(() => {
                moonIcon.innerText = "ü©∏"; // Troca o √≠cone
                moonIcon.style.color = "#ff0000";
            })
            .to(moonIcon, { 
                duration: 1.5, 
                scale: 2, 
                opacity: 1,
                textShadow: "0 0 60px #ff0000", 
                ease: "elastic.out(1, 0.3)" 
            })
            // 4. Pulsa√ß√£o Cont√≠nua (Loop)
            .to(moonIcon, {
                duration: 2,
                scale: 1.5,
                textShadow: "0 0 20px #8a0000",
                repeat: -1,
                yoyo: true,
                ease: "sine.inOut"
            });
            
            // 5. Ativar Shader da Lua Vermelha (Uniforms)
            if (redMoonMaterial) {
                gsap.to(redMoonMaterial.uniforms.uIntensity, {
                    value: 1.0, // Intensidade m√°xima
                    duration: 5,
                    ease: "power2.inOut"
                });
            }
            
            console.log("A Lua Vermelha ascendeu!");
        }

        // Sequ√™ncia de Ritual (GSAP + Lottie + Three.js)
        window.triggerEvolutionSequence = function() {
            const tl = gsap.timeline();
            const ritualContainer = document.getElementById('lottie-ritual');

            // Passo A: Zoom da C√¢mera 3D na Mesa (0,0,0)
            if (camera) {
                tl.to(camera.position, {
                    x: 0, y: 1, z: 2, // Aproxima do centro
                    duration: 1.5,
                    ease: "power2.inOut"
                });
            }

            // Passo B: Disparar Lottie M√≠stico
            tl.call(() => {
                ritualContainer.style.display = 'block';
                if(window.lottieRitual) {
                    window.lottieRitual.goToAndPlay(0);
                }
            })
            .to(ritualContainer, {
                opacity: 1,
                duration: 0.5
            }, "<") // Inicia junto com o call anterior
            // Passo C: Transe (Escurecer Tela)
            .to("body", {
                backgroundColor: "#000",
                duration: 0.3,
                yoyo: true,
                repeat: 1
            }, "+=0.5")
            // Reset
            .call(() => {
                if (camera) {
                    gsap.to(camera.position, {
                        x: 0, y: 2, z: 5, // Volta posi√ß√£o original
                        duration: 1.5, ease: "power2.out"
                    });
                }
            })
            .to(ritualContainer, {
                opacity: 0,
                duration: 0.5,
                onComplete: () => { ritualContainer.style.display = 'none'; }
            }, "<");
        }

        // Efeito de Sanidade no Lottie (Distor√ß√£o Temporal)
        window.updateSanityDistortion = function(sanityLevel) {
            if (!window.lottieLogin) return;
            
            // Se sanidade baixa (< 30), o rel√≥gio/olho gira freneticamente
            if (sanityLevel < 30) {
                gsap.to(window.lottieLogin, { timeScale: 5, duration: 1 });
            } else {
                gsap.to(window.lottieLogin, { timeScale: 1, duration: 1 });
            }
        }

        // --- Inicializa√ß√£o Three.js ---
        function init3D() {
            const container = document.getElementById('canvas-container');
            
            // Cena
            scene = new THREE.Scene();
            // Fog para fundir o ch√£o infinito com o fundo
            scene.fog = new THREE.FogExp2(0x0b0510, 0.02); 

            // C√¢mera (Foco em 0,0,0 conforme requisito)
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 5);
            camera.lookAt(0, 0, 0);
            scene.add(camera); // Necess√°rio para objetos filhos da c√¢mera renderizarem

            // Renderizador
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ReinhardToneMapping;
            container.appendChild(renderer.domElement);

            // --- Shader da Lua Vermelha (Post-FX Simulado) ---
            const redMoonGeometry = new THREE.PlaneGeometry(20, 20); // Tamanho suficiente para cobrir a tela
            
            // C√≥digo GLSL do Shader
            const vertexShader = `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `;

            const fragmentShader = `
                uniform float uTime;
                uniform float uIntensity;
                varying vec2 vUv;

                // Fun√ß√£o de Ru√≠do Simples (Pseudo-random)
                float hash(vec2 p) { return fract(1e4 * sin(17.0 * p.x + p.y * 0.1) * (0.1 + abs(sin(p.y * 13.0 + p.x)))); }
                float noise(vec2 x) {
                    vec2 i = floor(x);
                    vec2 f = fract(x);
                    float a = hash(i);
                    float b = hash(i + vec2(1.0, 0.0));
                    float c = hash(i + vec2(0.0, 1.0));
                    float d = hash(i + vec2(1.0, 1.0));
                    vec2 u = f * f * (3.0 - 2.0 * f);
                    return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
                }

                void main() {
                    // Vinheta (Escurecer bordas)
                    vec2 center = vUv - 0.5;
                    float dist = length(center);
                    float vignette = smoothstep(0.3, 0.8, dist);

                    // Efeito de Atmosfera (Ru√≠do em movimento)
                    float n = noise(vUv * 3.0 + uTime * 0.2);
                    
                    // Cor Vermelho Sangue
                    vec3 bloodColor = vec3(0.6, 0.05, 0.05);
                    
                    // Mistura final
                    vec3 finalColor = mix(vec3(0.0), bloodColor, 0.5 + 0.5 * n);
                    
                    // Alpha baseado na intensidade e vinheta
                    float alpha = uIntensity * (0.2 + 0.8 * vignette + 0.3 * n);
                    
                    gl_FragColor = vec4(finalColor, alpha);
                }
            `;

            redMoonMaterial = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 },
                    uIntensity: { value: 0.0 } // Come√ßa invis√≠vel
                },
                vertexShader: vertexShader,
                fragmentShader: fragmentShader,
                transparent: true,
                depthTest: false, // N√£o interagir com profundidade
                depthWrite: false
            });

            const redMoonMesh = new THREE.Mesh(redMoonGeometry, redMoonMaterial);
            redMoonMesh.position.z = -1; // Fica na frente da c√¢mera
            // Ajustar escala para cobrir o frustum da c√¢mera (aproximado)
            const aspect = window.innerWidth / window.innerHeight;
            redMoonMesh.scale.set(aspect, 1, 1); 
            
            camera.add(redMoonMesh); // Adiciona √† c√¢mera para seguir o jogador

            // --- Configura√ß√£o do Raycaster (Interatividade) ---
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Listeners de Mouse
            window.addEventListener('click', onMouseClick);
            window.addEventListener('mousemove', onMouseMove);

            // Luzes (Atmosfera M√≠stica)
            const ambientLight = new THREE.AmbientLight(0x404040, 1.5); // Luz base suave
            scene.add(ambientLight);

            const spotLight = new THREE.SpotLight(0xc5a059, 10);
            spotLight.position.set(5, 8, 5);
            spotLight.angle = Math.PI / 6;
            spotLight.penumbra = 1;
            spotLight.castShadow = true;
            scene.add(spotLight);

            // Carregar Modelo GLB
            const loader = new GLTFLoader();
            // Placeholder: Substitua pelo caminho do seu arquivo .glb
            loader.load('./assets/models/cenario_beckland.glb', (gltf) => {
                modelGroup = gltf.scene;
                scene.add(modelGroup);

                // Cache de objetos para GSAP ("Nomenclatura √© Tudo")
                modelGroup.traverse((child) => {
                    if (child.isMesh) {
                        // Salva refer√™ncia se tiver nome importante
                        objectsToAnimate[child.name] = child;
                    }
                });
            }, undefined, (error) => {
                console.log("Modelo n√£o encontrado (usando placeholder):", error);
                // Geometria de fallback para testes
                const geometry = new THREE.IcosahedronGeometry(1, 0);
                const material = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.2, metalness: 0.8 });
                const mesh = new THREE.Mesh(geometry, material);
                scene.add(mesh);
                objectsToAnimate["Placeholder"] = mesh;
            });

            // Loop de Anima√ß√£o
            function animate() {
                requestAnimationFrame(animate);
                // Atualizar tempo do shader
                if (redMoonMaterial) redMoonMaterial.uniforms.uTime.value += 0.01;
                renderer.render(scene, camera);
            }
            animate();

            // Responsividade
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // --- Fun√ß√µes de Intera√ß√£o (Raycaster) ---
        function onMouseClick(event) {
            // Evita clique se estiver interagindo com UI (bot√µes, pain√©is)
            if (event.target.closest('button') || event.target.closest('.panel') || event.target.closest('.chat-box')) return;

            // Normalizar coordenadas do mouse (-1 a +1)
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            if (!camera || !scene) return;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);

            if (intersects.length > 0) {
                const object = intersects[0].object;
                console.log("Objeto 3D clicado:", object.name);

                // L√≥gica: Se clicar na Po√ß√£o (ou no Placeholder de teste)
                if (object.name.includes("Potion") || object.name === "Placeholder") {
                    // Executa a sequ√™ncia de evolu√ß√£o
                    triggerEvolutionSequence();
                }
            }
        }

        function onMouseMove(event) {
            // Muda o cursor para 'pointer' se passar sobre algo interativo
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            if (!camera || !scene) return;
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObjects(scene.children, true);
            const isInteractive = intersects.length > 0 && (intersects[0].object.name.includes("Potion") || intersects[0].object.name === "Placeholder");
            document.body.style.cursor = isInteractive ? 'pointer' : 'default';
        }

        window.toggleSettings = function() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }
    </script>
</body>
</html>         opacity: 0, 
                ease: "back.in(1.7)" 
            })
            // 3. Explos√£o da Lua de Sangue
            .call(() => {
                moonIcon.innerText = "ü©∏"; // Troca o √≠cone
                moonIcon.style.color = "#ff0000";
            })
            .to(moonIcon, { 
                duration: 1.5, 
                scale: 2, 
                opacity: 1,
                textShadow: "0 0 60px #ff0000", 
                ease: "elastic.out(1, 0.3)" 
            })
            // 4. Pulsa√ß√£o Cont√≠nua (Loop)
            .to(moonIcon, {
                duration: 2,
                scale: 1.5,
                textShadow: "0 0 20px #8a0000",
                repeat: -1,
                yoyo: true,
                ease: "sine.inOut"
            });
            
            // 5. Ambiente fica vermelho gradualmente
            gsap.to(overlay, {
                duration: 4,
                opacity: 1,
                ease: "power2.inOut"
            });
            
            console.log("A Lua Vermelha ascendeu!");
        }

        // Sequ√™ncia de Ritual (GSAP + Lottie)
        window.triggerEvolutionSequence = function() {
            const tl = gsap.timeline();
            const gameScreen = document.getElementById('screen-game');
            const ritualContainer = document.getElementById('lottie-ritual');

            // Passo A: Zoom na "Mesa" (Simulado com Scale)
            tl.to(gameScreen, {
                scale: 1.1,
                duration: 1.5,
                ease: "power2.inOut"
            })
            // Passo B: Disparar Lottie M√≠stico
            .call(() => {
                ritualContainer.style.display = 'block';
                if(window.lottieRitual) {
                    window.lottieRitual.goToAndPlay(0);
                }
            })
            .to(ritualContainer, {
                opacity: 1,
                duration: 0.5
            }, "<") // Inicia junto com o call anterior
            // Passo C: Transe (Escurecer Tela)
            .to("body", {
                backgroundColor: "#000",
                duration: 0.3,
                yoyo: true,
                repeat: 1
            }, "+=0.5")
            // Reset
            .to(gameScreen, {
                scale: 1,
                duration: 1,
                ease: "power2.out"
            })
            .to(ritualContainer, {
                opacity: 0,
                duration: 0.5,
                onComplete: () => { ritualContainer.style.display = 'none'; }
            }, "<");
        }

        // Efeito de Sanidade no Lottie (Distor√ß√£o Temporal)
        window.updateSanityDistortion = function(sanityLevel) {
            if (!window.lottieLogin) return;
            
            // Se sanidade baixa (< 30), o rel√≥gio/olho gira freneticamente
            if (sanityLevel < 30) {
                gsap.to(window.lottieLogin, { timeScale: 5, duration: 1 });
            } else {
                gsap.to(window.lottieLogin, { timeScale: 1, duration: 1 });
            }
        }

        window.toggleSettings = function() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }
    </script>
</body>

</html>
