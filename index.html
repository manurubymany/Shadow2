<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Misterios Pixelados</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <style>
        :root {
            /* Paleta Dark */
            --bg-deep: #0b0510;
            --bg-panel: #1a1420;
            --accent-gold: #cfa848;
            --accent-vital: #b93b3b;
            --sanity-color: #8b5fbf;
            --text-main: #e0d8c8;
            
            /* Fontes */
            --font-header: 'Press Start 2P', cursive;
            --font-text: 'VT323', monospace;
        }

        body {
            margin: 0; padding: 0;
            background-color: #000;
            color: var(--text-main);
            font-family: var(--font-text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            image-rendering: pixelated; 
        }

        /* Viewport do Jogo (640x360 base) */
        #game-viewport {
            width: 640px;
            height: 360px;
            background: var(--bg-deep);
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            transform-origin: center;
            overflow: hidden;
        }

        /* Camada 3D */
        #canvas-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
        }
        
        /* Efeitos de Tela */
        .vignette-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 40%, #000 95%);
            pointer-events: none; z-index: 5;
        }
        .scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            pointer-events: none; z-index: 6; opacity: 0.5;
        }

        /* --- UI LAYOUT --- */
        
        /* TOPO: Status */
        .hud-top {
            position: absolute; top: 0; left: 0; width: 100%; height: 40px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; box-sizing: border-box; z-index: 10;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }

        .status-bars { display: flex; gap: 15px; align-items: center; }
        .bar-group { display: flex; flex-direction: column; gap: 2px; }
        .bar-label { font-size: 14px; font-family: var(--font-header); text-shadow: 1px 1px 0 #000; }
        
        .bar-container {
            width: 100px; height: 8px; background: #111; border: 1px solid #444;
            box-shadow: 0 0 5px rgba(0,0,0,0.5); position: relative;
        }
        .bar-fill { height: 100%; width: 100%; transition: width 0.3s; }
        .bar-fill.sanity { background: var(--sanity-color); box-shadow: 0 0 5px var(--sanity-color); }
        .bar-fill.life { background: var(--accent-vital); box-shadow: 0 0 5px var(--accent-vital); }

        .menu-btn {
            background: transparent; border: 2px solid var(--accent-gold);
            color: var(--accent-gold); font-family: var(--font-header);
            font-size: 10px; padding: 5px; cursor: pointer;
        }
        .menu-btn:hover { background: var(--accent-gold); color: #000; }

        /* RODAPÉ: Diálogo + Poções */
        .hud-bottom {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 90px;
            display: flex; gap: 10px; padding: 10px; box-sizing: border-box; z-index: 10;
            background: linear-gradient(to top, rgba(0,0,0,0.95) 80%, transparent);
        }

        .pixel-panel {
            background: var(--bg-panel); border: 2px solid var(--accent-gold);
            box-shadow: inset 0 0 0 2px #000; padding: 5px; position: relative;
        }

        .dialog-box {
            flex-grow: 1; display: flex; flex-direction: column;
        }
        .dialog-content {
            flex-grow: 1; overflow-y: auto; font-size: 16px; 
            line-height: 1.2; color: #ccc; margin-bottom: 5px;
            scrollbar-width: none;
        }
        .dialog-input {
            background: transparent; border: none; border-top: 1px solid #333;
            color: #fff; font-family: var(--font-text); font-size: 16px; width: 100%;
        }
        .dialog-input:focus { outline: none; border-color: var(--accent-gold); }

        .potions-dock {
            width: 200px; display: flex; gap: 4px; 
            justify-content: center; align-items: center;
        }
        .potion-slot {
            width: 32px; height: 32px; background: #000; border: 1px solid #555;
            position: relative; display: flex; justify-content: center; align-items: center;
            font-family: var(--font-header); font-size: 12px; color: #555;
            cursor: pointer;
        }
        .potion-slot span { position: absolute; bottom: -8px; right: -2px; font-size: 8px; color: #888; }
        .potion-slot.active { border-color: #fff; transform: translateY(1px); }

        /* --- SCREENS (Login/Lobby) --- */
        .screen {
            display: none; width: 100%; height: 100%;
            position: absolute; top: 0; left: 0; background: rgba(0,0,0,0.9);
            z-index: 100; flex-direction: column; justify-content: center; align-items: center;
        }
        .screen.active { display: flex; }

        .login-panel {
            width: 400px; text-align: center; padding: 20px;
        }
        h1 { 
            font-family: var(--font-header); color: var(--accent-gold); 
            font-size: 20px; text-transform: uppercase; margin-bottom: 20px;
        }
        input {
            background: #000; border: 2px solid #555; color: #fff;
            font-family: var(--font-text); font-size: 18px; padding: 5px;
            width: 80%; text-align: center; margin-bottom: 15px;
        }

        /* Seletor de Classes Customizado */
        .affinity-selector {
            display: flex; justify-content: center; gap: 10px; margin: 15px 0;
        }
        .affinity-icon {
            width: 40px; height: 40px; background: #000; border: 2px solid #444;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; position: relative; transition: all 0.2s;
            font-family: var(--font-header); font-size: 14px; color: #666;
        }
        .affinity-icon:hover, .affinity-icon.selected {
            border-color: var(--accent-gold); color: var(--accent-gold);
            box-shadow: 0 0 5px var(--accent-gold);
        }
        
        .tooltip {
            visibility: hidden; background: var(--bg-panel); color: var(--accent-gold);
            padding: 4px; position: absolute; bottom: 45px; left: 50%;
            transform: translateX(-50%); border: 1px solid var(--accent-gold);
            font-family: var(--font-text); font-size: 14px; white-space: nowrap;
            z-index: 10; opacity: 0; transition: opacity 0.2s;
        }
        .affinity-icon:hover .tooltip { visibility: visible; opacity: 1; }

        button.start-btn {
            background: var(--accent-vital); color: #fff; border: 2px solid #fff;
            padding: 10px 20px; font-family: var(--font-header); font-size: 10px;
            cursor: pointer; box-shadow: 4px 4px 0 #000;
        }
        button.start-btn:hover { transform: translate(-2px, -2px); }

    </style>
</head>
<body>

    <div id="game-viewport">
        <div id="canvas-container"></div>
        <div class="vignette-overlay"></div>
        <div class="scanlines"></div>

        <div id="screen-login" class="screen active">
            <div class="pixel-panel login-panel">
                <h1>Misterios Pixelados</h1>
                <input type="text" id="player-name" placeholder="NOME DO BEYONDER">
                
                <div style="font-size:14px; color:#888;">ESCOLHA SEU CAMINHO:</div>
                <div class="affinity-selector">
                    <div class="affinity-icon" onclick="selectAffinity('louco', this)">
                        LO <span class="tooltip">Louco</span>
                    </div>
                    <div class="affinity-icon" onclick="selectAffinity('espectador', this)">
                        ES <span class="tooltip">Espectador</span>
                    </div>
                    <div class="affinity-icon" onclick="selectAffinity('aprendiz', this)">
                        AP <span class="tooltip">Aprendiz</span>
                    </div>
                    <div class="affinity-icon" onclick="selectAffinity('marinheiro', this)">
                        MA <span class="tooltip">Marinheiro</span>
                    </div>
                    <div class="affinity-icon" onclick="selectAffinity('bruxa', this)">
                        BR <span class="tooltip">Bruxa</span>
                    </div>
                </div>

                <button class="start-btn" onclick="handleLogin()">INICIAR RITUAL</button>
            </div>
        </div>

        <div id="game-hud" style="display: none; width: 100%; height: 100%; position: absolute; top:0; left:0;">
            
            <div class="hud-top">
                <div class="status-bars">
                    <div class="bar-group">
                        <span class="bar-label" style="color:var(--sanity-color)">SAN</span>
                        <div class="bar-container"><div class="bar-fill sanity" id="san-bar"></div></div>
                    </div>
                    <div class="bar-group">
                        <span class="bar-label" style="color:var(--accent-vital)">VID</span>
                        <div class="bar-container"><div class="bar-fill life" id="life-bar"></div></div>
                    </div>
                </div>
                <button class="menu-btn" onclick="location.reload()">MENU</button>
            </div>

            <div class="hud-bottom">
                <div class="pixel-panel dialog-box">
                    <div class="dialog-content" id="chat-log">
                        <div style="color:#666;">> Sistema inicializado...</div>
                    </div>
                    <input type="text" class="dialog-input" id="chat-input" placeholder="Comando..." onkeypress="handleChat(event)">
                </div>

                <div class="pixel-panel potions-dock">
                    <div class="potion-slot" id="slot-x" style="color:#d0f">P1<span>X</span></div>
                    <div class="potion-slot" id="slot-e" style="color:#f00">P2<span>E</span></div>
                    <div class="potion-slot" id="slot-a" style="color:#fd0">P3<span>A</span></div>
                    <div class="potion-slot" id="slot-m" style="color:#0f0">P4<span>M</span></div>
                    <div class="potion-slot" id="slot-t" style="color:#00f">P5<span>T</span></div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import * as THREE from 'three';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI", // Preencha com sua chave
            databaseURL: "https://mystery02-864a8-default-rtdb.firebaseio.com/",
            projectId: "mystery02-864a8"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.gameState = { 
            name: '', 
            affinity: '',
            roomCode: 'global_lobby' 
        };

        // --- SCALE LOGIC ---
        function resize() {
            const vp = document.getElementById('game-viewport');
            const scale = Math.min(window.innerWidth/640, window.innerHeight/360);
            vp.style.transform = `scale(${scale})`;
        }
        window.addEventListener('resize', resize);
        window.addEventListener('load', resize);

        // --- UI LOGIC ---
        window.selectAffinity = (aff, el) => {
            gameState.affinity = aff;
            document.querySelectorAll('.affinity-icon').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
        }

        window.handleLogin = () => {
            const name = document.getElementById('player-name').value;
            if(!name || !gameState.affinity) return alert("Preencha Nome e Classe!");
            gameState.name = name;
            
            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('game-hud').style.display = 'block';
            
            if(!scene) init3D();
            connectChat();
        }

        // --- CHAT & ATALHOS ---
        window.handleChat = (e) => {
            if(e.key === 'Enter') {
                const input = document.getElementById('chat-input');
                push(ref(db, 'chat/' + gameState.roomCode), {
                    user: gameState.name,
                    text: input.value,
                    class: gameState.affinity
                });
                input.value = '';
            }
        }

        function connectChat() {
            onValue(ref(db, 'chat/' + gameState.roomCode), (snap) => {
                const log = document.getElementById('chat-log');
                log.innerHTML = '';
                const msgs = snap.val() || {};
                Object.values(msgs).slice(-10).forEach(m => {
                    const div = document.createElement('div');
                    div.innerHTML = `<span style="color:${getColor(m.class)}">${m.user}:</span> ${m.text}`;
                    log.appendChild(div);
                });
                log.scrollTop = log.scrollHeight;
            });
        }

        function getColor(cls) {
            const colors = { louco:'#d0f', espectador:'#fd0', aprendiz:'#00f', marinheiro:'#0f0', bruxa:'#f00' };
            return colors[cls] || '#ccc';
        }

        // Teclas de Atalho (Poções)
        window.addEventListener('keydown', (e) => {
            const key = e.key.toUpperCase();
            const map = { 'X':'slot-x', 'E':'slot-e', 'A':'slot-a', 'M':'slot-m', 'T':'slot-t' };
            if(map[key]) {
                const el = document.getElementById(map[key]);
                el.classList.add('active');
                setTimeout(() => el.classList.remove('active'), 200);
                // Adicione lógica de uso da poção aqui
            }
        });

        // --- 3D ENGINE (Low Poly) ---
        let scene, camera, renderer, cube;
        function init3D() {
            const container = document.getElementById('canvas-container');
            
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x0b0510, 0.15);

            camera = new THREE.PerspectiveCamera(75, 640/360, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true });
            renderer.setSize(320, 180); // Resolução interna baixa para pixelar
            renderer.domElement.style.width = "100%";
            renderer.domElement.style.height = "100%";
            container.appendChild(renderer.domElement);

            // Luz
            const pLight = new THREE.PointLight(0xcfa848, 2, 20);
            pLight.position.set(2, 2, 2);
            scene.add(pLight);
            scene.add(new THREE.AmbientLight(0x222222));

            // Cubo Placeholder
            const geo = new THREE.BoxGeometry(1, 1, 1);
            const mat = new THREE.MeshStandardMaterial({ color: 0x8b5fbf, roughness: 0.6 });
            cube = new THREE.Mesh(geo, mat);
            scene.add(cube);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if(cube) {
                cube.rotation.x += 0.01;
                cube.rotation.y += 0.01;
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
